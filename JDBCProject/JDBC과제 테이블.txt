--테이블데이터 삭제
DELETE FROM SALE;
DELETE FROM INVENTORY;
DELETE FROM WARECHOUSING;
DELETE FROM DELIVERY;
DELETE FROM MEAT;

--테이블 삭제
DROP TABLE SALE;
DROP TABLE INVENTORY;
DROP TABLE WARECHOUSING;
DROP TABLE MEAT;
DROP TABLE DELIVERY;

--공급업체
CREATE TABLE DELIVERY(
	DCODE NUMBER(5) PRIMARY KEY,
	DCOMPANYNAME VARCHAR2(30) NOT NULL,
	DCOMPANYADDR VARCHAR(200),
	CONTRACTENDDATE DATE
);

--고기
CREATE TABLE MEAT(
	MEATCODE VARCHAR2(8) PRIMARY KEY,
	MEATTYPE VARCHAR2(15) NOT NULL CHECK(MEATTYPE IN('닭고기','돼지고기','쇠고기')),
	MEATAREA VARCHAR2(15) NOT NULL,
	ORIGIN VARCHAR2(10) NOT NULL,
	GRADE VARCHAR2(10) NOT NULL,
	TOTAL_STOCK NUMBER(7),
	PRICE NUMBER(7) NOT NULL
);

--입고
CREATE TABLE WARECHOUSING(
	WCODE VARCHAR2(10) PRIMARY KEY,
	MEATCODE VARCHAR2(8) REFERENCES MEAT(MEATCODE) NOT NULL,
	MEATAMOUNT NUMBER(7) NOT NULL,
	ARRIVAL_TIME DATE NOT NULL,
	EXPIRATION_DATE DATE NOT NULL,
	PRICE NUMBER(7) NOT NULL,
	DCODE NUMBER(5) REFERENCES DELIVERY(DCODE)
);

--재고
CREATE TABLE INVENTORY(
	WCODE VARCHAR2(10) PRIMARY KEY REFERENCES WARECHOUSING(WCODE),
	REMAININGAMOUNT NUMBER(7) NOT NULL
);

--판매
CREATE TABLE SALE(
	SCODE VARCHAR2(10) PRIMARY KEY,
	WCODE VARCHAR2(10) NOT NULL REFERENCES INVENTORY(WCODE),
	SALEMOUNT NUMBER(7) NOT NULL,
	SPRICE NUMBER(7) NOT NULL,
	SALEDATE DATE NOT NULL
);

--시퀀스 생성
DROP SEQUENCE DEL_SEQ;
CREATE SEQUENCE DEL_SEQ;
DROP SEQUENCE WAR_SEQ;
CREATE SEQUENCE WAR_SEQ;
DROP SEQUENCE INV_SEQ;
CREATE SEQUENCE INV_SEQ;
DROP SEQUENCE SALE_SEQ;
CREATE SEQUENCE SALE_SEQ;

--재고 트리거
--입고되면 재고에 추가되는 트리거
CREATE OR REPLACE TRIGGER INVENROTYADD
AFTER INSERT ON WARECHOUSING
FOR EACH ROW
DECLARE
BEGIN
		    
	INSERT INTO INVENTORY VALUES(:NEW.WCODE,:NEW.MEATAMOUNT);
END;
/

--판매되면 판매한 양만큼 빠져나가는 트리거
CREATE OR REPLACE TRIGGER INVENTORYDEL
AFTER INSERT ON SALE
FOR EACH ROW
DECLARE
BEGIN
    UPDATE INVENTORY SET REMAININGAMOUNT=REMAININGAMOUNT-:NEW.SALEMOUNT
    WHERE WCODE=:NEW.WCODE;
END;
/

--메인화면 뷰 생성
CREATE OR REPLACE VIEW MAINVIEW
AS
SELECT W.WCODE,M.MEATTYPE,M.MEATAREA,M.GRADE,M.ORIGIN,W.ARRIVAL_TIME,W.MEATAMOUNT,W.EXPIRATION_DATE,I.REMAININGAMOUNT
FROM WARECHOUSING W,MEAT M,INVENTORY I
WHERE W.MEATCODE=M.MEATCODE AND W.WCODE=I.WCODE;